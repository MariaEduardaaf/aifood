generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  WAITER
  ADMIN
  MANAGER
}

enum CallType {
  CALL_WAITER
  REQUEST_BILL
}

enum CallStatus {
  OPEN
  RESOLVED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String
  name          String
  role          Role
  active        Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  resolved_calls   Call[]  @relation("ResolvedBy")
  confirmed_orders Order[] @relation("ConfirmedBy")
}

model Table {
  id         String   @id @default(cuid())
  label      String
  qr_token   String   @unique @default(cuid())
  active     Boolean  @default(true)
  created_at DateTime @default(now())

  calls  Call[]
  orders Order[]
}

model Call {
  id          String     @id @default(cuid())
  table_id    String
  type        CallType
  status      CallStatus @default(OPEN)
  created_at  DateTime   @default(now())
  resolved_at DateTime?
  resolved_by String?

  table    Table  @relation(fields: [table_id], references: [id], onDelete: Cascade)
  resolver User?  @relation("ResolvedBy", fields: [resolved_by], references: [id])
  rating   Rating?

  @@index([status])
  @@index([table_id])
  @@index([created_at])
}

model Rating {
  id                String   @id @default(cuid())
  call_id           String   @unique
  stars             Int      // 1-5
  feedback          String?  // comentário se nota baixa
  redirected_google Boolean  @default(false) // foi redirecionado pro Google?
  created_at        DateTime @default(now())

  call Call @relation(fields: [call_id], references: [id], onDelete: Cascade)

  @@index([stars])
  @@index([created_at])
}

model Settings {
  id                  String  @id @default("default")
  google_reviews_url  String? // URL do Google Reviews do restaurante
  google_reviews_enabled Boolean @default(true)
  min_stars_redirect  Int     @default(4) // nota mínima para redirecionar
}

// ============ FASE 2: CARDÁPIO DIGITAL ============

model Category {
  id         String   @id @default(cuid())
  name_pt    String
  name_es    String
  name_en    String
  order      Int      @default(0)
  active     Boolean  @default(true)
  created_at DateTime @default(now())

  items MenuItem[]

  @@index([order])
  @@index([active])
}

model MenuItem {
  id             String   @id @default(cuid())
  category_id    String
  name_pt        String
  name_es        String
  name_en        String
  description_pt String?
  description_es String?
  description_en String?
  price          Decimal  @db.Decimal(10, 2)
  image_url      String?
  active         Boolean  @default(true)
  order          Int      @default(0)
  created_at     DateTime @default(now())

  category   Category    @relation(fields: [category_id], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([category_id])
  @@index([active])
  @@index([order])
}

// ============ FASE 3: SISTEMA DE PEDIDOS ============

enum OrderStatus {
  PENDING    // Aguardando confirmacao do garcom
  CONFIRMED  // Garcom confirmou, enviado para preparo
  PREPARING  // Cozinha preparando (Fase 4)
  READY      // Pronto para entrega (Fase 4)
  DELIVERED  // Entregue ao cliente
  CANCELLED  // Cancelado
}

model Order {
  id           String      @id @default(cuid())
  table_id     String
  status       OrderStatus @default(PENDING)
  total        Decimal     @db.Decimal(10, 2)
  notes        String?     // Observacoes gerais do pedido
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt
  confirmed_at DateTime?   // Quando garcom confirmou
  delivered_at DateTime?   // Quando foi entregue
  confirmed_by String?     // ID do garcom que confirmou

  table     Table       @relation(fields: [table_id], references: [id], onDelete: Cascade)
  confirmer User?       @relation("ConfirmedBy", fields: [confirmed_by], references: [id])
  items     OrderItem[]

  @@index([table_id])
  @@index([status])
  @@index([created_at])
}

model OrderItem {
  id           String  @id @default(cuid())
  order_id     String
  menu_item_id String
  quantity     Int
  unit_price   Decimal @db.Decimal(10, 2) // Preco no momento do pedido
  notes        String? // Ex: "sem cebola", "bem passado"

  order    Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  menuItem MenuItem @relation(fields: [menu_item_id], references: [id])

  @@index([order_id])
}
